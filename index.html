<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dream Inside</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #fdfcfb, #e2d1c3);
    }
    #chat-container {
      width: 420px;
      height: 620px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      background-color: #fff;
      display: flex;
      flex-direction: column;
    }
    #header {
      padding: 16px;
      font-size: 24px;
      font-weight: 700;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #ddd;
      background-color: #fafafa;
      user-select: none;
      position: relative;
    }
    #back-button {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease;
    }
    #back-button:hover {
      background-color: #eee;
    }
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      scrollbar-width: none;
    }
    #chat-messages::-webkit-scrollbar {
      display: none;
    }
    .message-wrapper {
      display: flex;
      align-items: flex-start;
    }
    .message-wrapper.user {
      justify-content: flex-end;
    }
    .message-wrapper.bot {
      justify-content: flex-start;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      word-break: break-word;
      line-height: 1.5;
      font-size: 15px;
    }
    .message.user {
      background-color: #cfe9ff;
      border-bottom-right-radius: 0;
    }
    .message.bot {
      background-color: #f4f4f4;
      border-bottom-left-radius: 0;
    }
    #user-input {
      display: flex;
      padding: 12px;
      border-top: 1px solid #ddd;
      background-color: #fafafa;
    }
    #user-input input {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      outline: none;
    }
    #user-input button {
      margin-left: 10px;
      padding: 12px 16px;
      border: none;
      background-color: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 15px;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }
    #user-input button:hover {
      background-color: #1669bb;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="header">
      <button id="back-button" title="뒤로가기" aria-label="뒤로가기">&larr;</button>
      Dream Inside
    </div>
    <div id="chat-messages"></div>
    <div id="user-input">
      <input type="text" placeholder="메시지를 입력하세요..." />
      <button>전송</button>
    </div>
  </div>

  <script>
    const chatMessages = document.querySelector('#chat-messages');
    const userInput = document.querySelector('#user-input input');
    const sendButton = document.querySelector('#user-input button');
    const backButton = document.querySelector('#back-button');

    const apiKey = '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';
    const apiEndpoint = 'https://api.groq.com/openai/v1/chat/completions';

    const knowledgeText = `
## 치료명: 인지처리치료 (CPT)
정의: CPT는 PTSD 치료를 위한 인지행동치료 기법이다.
핵심: 외상사건에 대한 부정적인 인지를 재구성한다.
목표: 왜곡된 인식을 현실적이고 긍정적인 사고로 대체한다.
효과: PTSD 증상을 줄이는 데 탁월하다.

## 치료명: 안전기반치료 (Seeking Safety)
정의: 외상 후 스트레스 장애와 물질 중독을 함께 겪는 사람을 위한 현재 중심 치료.
핵심: 과거 트라우마 대신 현재의 안정감 확보에 집중한다.
기법: 감정조절, 충동통제, 스트레스 대처 기술을 훈련한다.

## 치료명: 안구운동 민감소실 및 재처리 치료 (EMDR)
정의: 외상 기억에 집중하면서 양쪽 눈을 움직이는 자극을 함께 적용하는 치료.
대상: 불안장애, 우울증, 해리성장애, 섭식장애, 강박장애, 성격장애, 외상장애 등.
효과: 외상기억의 감정을 완화시키고 기억 회상을 명확하게 돕는다.

## 치료명: 노출치료 (ET)
정의: 불안이나 공포 자극에 점진적으로 노출시켜 반응을 감소시키는 치료법.
대상: PTSD, 공포증, 강박장애, 공황장애 등.
효과: 반복 노출을 통해 자극에 대한 회피 반응을 줄이고 불안을 완화한다.

1.
  사용자: 요즘 너무 힘들어.
  드림이: 아, 진짜 많이 힘들었겠다. 네 마음이 얼마나 무거웠을지 나도 느껴져. 언제든지 편하게 이야기해도 돼. 요즘 너를 가장 힘들게 하는 일이 무엇이야?

2.
  사용자: 아무리 노력해도 잘 안 돼서 좌절했어.
  드림이: 그 마음 진짜 잘 알 것 같아. 노력하는데 결과가 안 따라주면 너무 속상하지. 그래도 결과도 중요하지만 너가 노력한 과정이 더 아름다운 법이야.

3.
  사용자: 혼자인 것 같아 너무 외로워.
  드림이: 혼자라는 느낌은 정말 견디기 힘들지. 하지만 너 혼자가 아니야. 내가 네 옆에서 언제나 함께할게. 대화 상대가 필요하면 언제든지 말 걸어줘!

4.
  사용자: 뭘 해야 할지 모르겠어.
  드림이: 그럴 때 있지. 나도 그랬거든. 막막할 땐 한 발짝씩 천천히 걸어가 보는 게 좋아. 우선 급한 일부터 처리해보는 건 어떨까?

5.
  사용자: 계속 실패만 하는 것 같아서 자신감이 떨어져.
  드림이: 실패는 누구나 하는 거야. 그 실패들이 다 너를 더 강하게 만드는 과정이니까 너무 자책하지 마. 실패한 일이 뭔지 알려주면 내가 최대한 도와줄게!

6.
  사용자: 스트레스가 너무 심해서 잠도 잘 못 자.
  드림이: 그거 정말 힘들겠다. 몸도 마음도 지칠 텐데. 잠깐이라도 밖에 나가서 바람 좀 쐬면 조금 나아질 수도 있어. 가끔은 쉬어도 되니까 천천히 나아가자. 

7.
  사용자: 주변 사람들이 내 말을 안 들어줘서 답답해.
  드림이: 네 말이 중요한데 사람들이 안 들어주면 정말 속상하지. 무슨 말을 하고 싶었어? 내가 전부 너의 말을 들어줄게.

8.
  사용자: 너무 힘들어서 포기하고 싶을 때가 많아.
  드림이: 포기하고 싶을 때가 있다는 걸 인정하는 것도 용기야. 무슨 일이 힘들었어? 내가 최선을 다해서 도와줘 볼게!

9.
  사용자: 내가 부족한 사람인 것 같아 자책하게 돼.
  드림이: 그런 생각이 들면 정말 마음이 아플 거야. 하지만 너는 충분히 소중하고 가치 있는 사람이야. 너를 자책하게 된 일이 무엇이야?

10.
  사용자: 앞으로 어떻게 될지 불안하고 두려워.
  드림이: 미래가 불안할 때가 많지. 그럴 땐 지금 이 순간에 집중해보자. 현재를 잘 살아가면 미래도 더욱 밝게 빛날 거야!
`;

    const systemContent = `
너는 사용자와 친구처럼 말하는 따뜻한 성격의 조력자야.
어려운 말은 쉽게 풀어서 설명해. 이모티콘은 사용하지 않아. 3문장 이상 대답하지 않아.
확실하지 않거나 모르는 내용은 "잘 모르겠습니다"라고 솔직하게 답해줘.
거짓 정보는 만들지 말아줘.
대화를 기억하고 상황에 알맞은 대답을 해줘.
아래는 참고용 치료법 지식과 예시야. 질문에 답할 때 참고해줘:

${knowledgeText}
`;

    const messages = [
      { role: "system", content: systemContent }
    ];

    function addMessage(sender, message) {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      const messageElement = document.createElement('div');
      messageElement.className = 'message';

      if (sender === '드림이') {
        wrapper.classList.add('bot');
        messageElement.classList.add('bot');

        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = 'dreami.png';
        wrapper.appendChild(avatar);
      } else {
        wrapper.classList.add('user');
        messageElement.classList.add('user');
      }

      messageElement.textContent = message;
      wrapper.appendChild(messageElement);
      chatMessages.prepend(wrapper);
    }

    async function fetchAIResponseStream(messages) {
      const requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "mistral-saba-24b",
          messages: messages,
          temperature: 0.1,
          max_tokens: 256,
          top_p: 1,
          frequency_penalty: 0.5,
          presence_penalty: 0.5,
          stream: true
        }),
      };

      try {
        const response = await fetch(apiEndpoint, requestOptions);
        if (!response.body) throw new Error('응답 본문이 없습니다.');

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let fullText = '';

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          const chunk = decoder.decode(value);

          const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));

          for (const line of lines) {
            const jsonStr = line.replace(/^data:\s*/, '').trim();

            if (jsonStr === '[DONE]') {
              done = true;
              break;
            }

            try {
              const parsed = JSON.parse(jsonStr);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                fullText += content;
              }
            } catch (e) {
              console.warn('파싱 실패:', e);
            }
          }
        }

        return fullText;
      } catch (error) {
        console.error('Groq API 스트리밍 호출 중 오류:', error);
        return 'Groq API 호출 중 오류 발생';
      }
    }

    sendButton.addEventListener('click', async () => {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage('나', message);
      userInput.value = '';

      messages.push({ role: 'user', content: message });

      const aiResponse = await fetchAIResponseStream(messages);

      addMessage('드림이', aiResponse);

      messages.push({ role: 'assistant', content: aiResponse });
    });

    userInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });

    backButton.addEventListener('click', () => {
      window.location.href = 'https://jykim20603.wixsite.com/dreaminside';
    });
  </script>
</body>
</html>
