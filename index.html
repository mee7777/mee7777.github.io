<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dream Inside</title>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Nanum Gothic', sans-serif;
    }

    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(135deg, #cbb4d4, #d6cadd, #a3b8d0);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    #chat-container {
      width: 420px;
      height: 620px;
      border-radius: 20px;
      backdrop-filter: blur(16px);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #header {
      position: relative;
      padding: 18px;
      font-size: 22px;
      font-weight: bold;
      color: #fff;
      text-align: center;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(8px);
    }

    #back-button {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background-color: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.2s;
    }

    #back-button:hover {
      background-color: rgba(255,255,255,0.35);
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
    }

    .message-wrapper {
      display: flex;
      align-items: flex-start;
    }

    .message-wrapper.user {
      justify-content: flex-end;
    }

    .message-wrapper.bot {
      justify-content: flex-start;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 20px;
      line-height: 1.5;
      font-size: 15px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .message.user {
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      border-bottom-right-radius: 0;
    }

    .message.bot {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border-bottom-left-radius: 0;
      backdrop-filter: blur(4px);
    }

    #user-input {
      display: flex;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(8px);
    }

    #user-input input {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border: none;
      border-radius: 12px;
      outline: none;
      background-color: rgba(255,255,255,0.8);
    }

    #user-input button {
      margin-left: 10px;
      padding: 12px 16px;
      border: none;
      background-color: #ae88f7;
      color: white;
      font-size: 15px;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #user-input button:hover {
      background-color: #9b73eb;
    }

    /* 스크롤 숨기기 */
    #chat-messages::-webkit-scrollbar {
      display: none;
    }
    #chat-messages {
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="header">
      <button id="back-button" title="뒤로가기" aria-label="뒤로가기">&larr;</button>
      Dream Inside
    </div>
    <div id="chat-messages"></div>
    <div id="user-input">
      <input type="text" placeholder="당신의 마음을 들려주세요..." />
      <button>전송</button>
    </div>
  </div>

  <script>
    const chatMessages = document.querySelector('#chat-messages');
    const userInput = document.querySelector('#user-input input');
    const sendButton = document.querySelector('#user-input button');
    const backButton = document.querySelector('#back-button');

    const apiKey = '여기에_API_KEY_숨기기_권장';
    const apiEndpoint = 'https://api.groq.com/openai/v1/chat/completions';

    const systemPrompt = `
너는 사용자와 친구처럼 따뜻하게 대화하는 조력자야.
몽환적인 감성과 안정감을 주는 말투로 이야기해.
이모티콘은 사용하지 않아. 간결하지만 다정하게 이야기해줘.
`;

    const messages = [
      { role: "system", content: systemPrompt }
    ];

    function addMessage(sender, message) {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      const messageElement = document.createElement('div');
      messageElement.className = 'message';

      if (sender === 'bot') {
        wrapper.classList.add('bot');
        messageElement.classList.add('bot');

        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = 'dreami.png';
        wrapper.appendChild(avatar);
      } else {
        wrapper.classList.add('user');
        messageElement.classList.add('user');
      }

      messageElement.textContent = message;
      wrapper.appendChild(messageElement);
      chatMessages.prepend(wrapper);
    }

    async function fetchAIResponseStream(messages) {
      const requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "mistral-saba-24b",
          messages: messages,
          temperature: 0.7,
          max_tokens: 256,
          stream: true
        }),
      };

      try {
        const response = await fetch(apiEndpoint, requestOptions);
        if (!response.body) throw new Error('응답 본문이 없습니다.');

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let fullText = '';

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          const chunk = decoder.decode(value);

          const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));

          for (const line of lines) {
            const jsonStr = line.replace(/^data:\s*/, '').trim();

            if (jsonStr === '[DONE]') {
              done = true;
              break;
            }

            try {
              const parsed = JSON.parse(jsonStr);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                fullText += content;
              }
            } catch (e) {
              console.warn('파싱 실패:', e);
            }
          }
        }

        return fullText;
      } catch (error) {
        console.error('Groq API 스트리밍 호출 중 오류:', error);
        return '답변을 가져오는 데 문제가 발생했어요.';
      }
    }

    sendButton.addEventListener('click', async () => {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage('user', message);
      userInput.value = '';

      messages.push({ role: 'user', content: message });

      const aiResponse = await fetchAIResponseStream(messages);

      addMessage('bot', aiResponse);

      messages.push({ role: 'assistant', content: aiResponse });
    });

    userInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });

    backButton.addEventListener('click', () => {
      window.location.href = 'https://jykim20603.wixsite.com/dreaminside';
    });
  </script>
</body>
</html>
