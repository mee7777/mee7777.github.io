<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dream Inside</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #fdfcfb, #e2d1c3);
    }
    #chat-container {
      width: 420px;
      height: 620px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      background-color: #fff;
      display: flex;
      flex-direction: column;
    }
    #header {
      padding: 16px;
      font-size: 24px;
      font-weight: 700;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #ddd;
      background-color: #fafafa;
      user-select: none;
      position: relative;
    }
    #back-button {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease;
    }
    #back-button:hover {
      background-color: #eee;
    }
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      scrollbar-width: none;
    }
    #chat-messages::-webkit-scrollbar {
      display: none;
    }
    .message-wrapper {
      display: flex;
      align-items: flex-start;
    }
    .message-wrapper.user {
      justify-content: flex-end;
    }
    .message-wrapper.bot {
      justify-content: flex-start;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      word-break: break-word;
      line-height: 1.5;
      font-size: 15px;
    }
    .message.user {
      background-color: #cfe9ff;
      border-bottom-right-radius: 0;
    }
    .message.bot {
      background-color: #f4f4f4;
      border-bottom-left-radius: 0;
    }
    #user-input {
      display: flex;
      padding: 12px;
      border-top: 1px solid #ddd;
      background-color: #fafafa;
    }
    #user-input input {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      outline: none;
    }
    #user-input button {
      margin-left: 10px;
      padding: 12px 16px;
      border: none;
      background-color: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 15px;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }
    #user-input button:hover {
      background-color: #1669bb;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="header">
      <button id="back-button" title="뒤로가기" aria-label="뒤로가기">&larr;</button>
      Dream Inside
    </div>
    <div id="chat-messages"></div>
    <div id="user-input">
      <input type="text" placeholder="메시지를 입력하세요..." />
      <button>전송</button>
    </div>
  </div>

  <script>
    const chatMessages = document.querySelector('#chat-messages');
    const userInput = document.querySelector('#user-input input');
    const sendButton = document.querySelector('#user-input button');
    const backButton = document.querySelector('#back-button');

    const apiKey = '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';
    const apiEndpoint = 'https://api.groq.com/openai/v1/chat/completions';

    const messages = [];

    async function loadKnowledgeText() {
      try {
        const response = await fetch('knowledge.txt');
        if (!response.ok) throw new Error('파일을 불러오지 못했습니다.');

        const text = await response.text();
        return text;
      } catch (error) {
        console.error(error);
        return '';
      }
    }

    async function init() {
      const knowledgeText = await loadKnowledgeText();

      const systemContent = `
너는 사용자와 친구처럼 말하는 따뜻한 성격의 조력자야.
어려운 말은 쉽게 풀어서 설명해. 이모티콘은 사용하지 않아. 3문장 이상 대답하지 않아.
확실하지 않거나 모르는 내용은 "잘 모르겠습니다"라고 솔직하게 답해줘.
거짓 정보는 만들지 말아줘.
대화를 기억하고 상황에 알맞은 대답을 해줘.
knowledgeText파일을 잘 확인하고 그것과 비슷하거나 같은 질문이 오면 정해진 답변을 해줘.
아래는 참고용 치료법 지식과 예시야. 질문에 답할 때 참고해줘:

${knowledgeText}
      `;

      messages.push({ role: "system", content: systemContent });
    }

    function addMessage(sender, message) {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      const messageElement = document.createElement('div');
      messageElement.className = 'message';

      if (sender === '드림이') {
        wrapper.classList.add('bot');
        messageElement.classList.add('bot');

        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = 'dreami.png';
        wrapper.appendChild(avatar);
      } else {
        wrapper.classList.add('user');
        messageElement.classList.add('user');
      }

      messageElement.textContent = message;
      wrapper.appendChild(messageElement);
      chatMessages.prepend(wrapper);
    }

    async function fetchAIResponseStream(messages) {
      const requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "mistral-saba-24b",
          messages: messages,
          temperature: 0.1,
          max_tokens: 256,
          top_p: 1,
          frequency_penalty: 0.5,
          presence_penalty: 0.5,
          stream: true
        }),
      };

      try {
        const response = await fetch(apiEndpoint, requestOptions);
        if (!response.body) throw new Error('응답 본문이 없습니다.');

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let fullText = '';

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          const chunk = decoder.decode(value);

          const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));

          for (const line of lines) {
            const jsonStr = line.replace(/^data:\s*/, '').trim();

            if (jsonStr === '[DONE]') {
              done = true;
              break;
            }

            try {
              const parsed = JSON.parse(jsonStr);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                fullText += content;
              }
            } catch (e) {
              console.warn('파싱 실패:', e);
            }
          }
        }

        return fullText;
      } catch (error) {
        console.error('Groq API 스트리밍 호출 중 오류:', error);
        return 'Groq API 호출 중 오류 발생';
      }
    }

    sendButton.addEventListener('click', async () => {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage('나', message);
      userInput.value = '';

      messages.push({ role: 'user', content: message });

      const aiResponse = await fetchAIResponseStream(messages);

      addMessage('드림이', aiResponse);

      messages.push({ role: 'assistant', content: aiResponse });
    });

    userInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });

    backButton.addEventListener('click', () => {
      window.location.href = 'https://jykim20603.wixsite.com/dreaminside';
    });

    // 초기화 함수 실행
    init();
  </script>
</body>
</html>
