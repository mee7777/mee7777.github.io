<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dream Inside</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #fdfcfb, #e2d1c3);
    }
    #chat-container {
      width: 420px;
      height: 620px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      background-color: #fff;
      display: flex;
      flex-direction: column;
    }
    #header {
      padding: 16px;
      font-size: 24px;
      font-weight: 700;
      color: #333;
      text-align: center;
      border-bottom: 1px solid #ddd;
      background-color: #fafafa;
      user-select: none;
      position: relative;
    }
    #back-button {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease;
    }
    #back-button:hover {
      background-color: #eee;
    }
    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      scrollbar-width: none;
    }
    #chat-messages::-webkit-scrollbar {
      display: none;
    }
    .message-wrapper {
      display: flex;
      align-items: flex-start;
    }
    .message-wrapper.user {
      justify-content: flex-end;
    }
    .message-wrapper.bot {
      justify-content: flex-start;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      word-break: break-word;
      line-height: 1.5;
      font-size: 15px;
    }
    .message.user {
      background-color: #cfe9ff;
      border-bottom-right-radius: 0;
    }
    .message.bot {
      background-color: #f4f4f4;
      border-bottom-left-radius: 0;
    }
    #user-input {
      display: flex;
      padding: 12px;
      border-top: 1px solid #ddd;
      background-color: #fafafa;
    }
    #user-input input {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
      outline: none;
    }
    #user-input button {
      margin-left: 10px;
      padding: 12px 16px;
      border: none;
      background-color: #1e88e5;
      color: white;
      cursor: pointer;
      font-size: 15px;
      border-radius: 10px;
      transition: background-color 0.2s ease;
    }
    #user-input button:hover {
      background-color: #1669bb;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="header">
      <button id="back-button" title="뒤로가기" aria-label="뒤로가기">&larr;</button>
      Dream Inside
    </div>
    <div id="chat-messages"></div>
    <div id="user-input">
      <input type="text" placeholder="메시지를 입력하세요..." />
      <button>전송</button>
    </div>
  </div>

  <script>
    const chatMessages = document.querySelector('#chat-messages');
    const userInput = document.querySelector('#user-input input');
    const sendButton = document.querySelector('#user-input button');
    const backButton = document.querySelector('#back-button');

    const apiKey = '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';
    const apiEndpoint = 'https://api.groq.com/openai/v1/chat/completions';

    const knowledgeText = ` * 내가 요리사가 돼서 맛있는 음식을 만들고 있었어 근데 . 재료들이 갑자기 노래를 부르기
시작해서 요리에 집중할 수가 없었어 깨니까 . . 배고팠어
 요리는 창작이나 어떤 것을 만들어내는 과정을 상징합니다 재료들이 . 노래를 부르는 것
은 당신의 창작 과정에서 예상치 못한 방해 요소가 나타나거나 집중하기 , 어려운 환경에 놓
여 있음을 나타낼 수 있습니다 목표 . 달성을 방해하는 외부 요인에 대한 답답함이 반영된
꿈입니다.
* 내가 좋아하는 캐릭터들이랑 같이 게임을 하고 있었어 근데 . 캐릭터들이 갑자기 내 말을
안 듣고 자기들 멋대로 움직이는 거야 깨니까 . 게임이 너무 답답했어.
 이 꿈은 당신의 통제력을 벗어난 상황에 대한 답답함이나 좌절감을 나타낼 수 있습니다.
특히 좋아하는 캐릭터는 자신이 통제하고 싶은 대상을 상징할 수 있으며 이들이 통제되지 ,
않는다는 것은 현실에서 비슷한 무력감을 느끼고 있음을 의미할 수 있습니다.
* 꿈에서 학교에 있었는데 갑자기 , 모든 친구들이 투명해져서 나 혼자만 보이는 거야 수업 .
은 계속 진행되는데 아무도 없는 빈 의자들 보면서 너무 외로웠어 깨고 . 나서도 뭔가 허전
한 느낌이 들었어.
 이 꿈은 현재 당신이 외로움이나 소외감을 느끼고 있음을 나타낼 수 있어요 주변 . 사람
들과의 관계에서 단절감을 경험하거나 중요한 , 상황에서 혼자 남겨질 것 같은 불안감을 반
영할 수도 있습니다 소속감에 . 대한 결핍이나 타인과의 교류 부재가 무의식적으로 드러난
것으로 볼 수 있습니다.
 * 하늘을 날고 있었는데 발밑에 , 우리 집이 엄청 작게 보였어 근데 . 갑자기 날개가 사라져
서 떨어지는 꿈을 꿨는데 깨니까 , 심장이 쿵쾅거렸어.
 하늘을 나는 꿈은 자유로움과 이상 추구를 상징하지만 날개가 , 사라져 떨어지는 것은 통
제력 상실과 좌절감을 의미합니다 어떤 . 목표를 향해 나아가던 중 예상치 못한 어려움으로
인해 실패할지도 모른다는 두려움이나 현재의 , 자유로운 상황이 위협받을 수 있다는 불안감
을 나타냅니다.
 * , 엘리베이터를 탔는데 버튼이 다 사라지고 층수도 계속 바뀌는 거야 어디로 . 가는지도 모
르고 계속 올라가기만 하는데 깨니까 , 뭔가 답답했어.
 엘리베이터는 인생의 변화나 목표 달성 과정을 상징해요 버튼이 . 사라지고 층수가 불규
칙하게 바뀌는 것은 당신의 삶이 현재 불확실성 속에 놓여있거나 미래에 , 대한 방향성을 잃
어버린 답답함을 나타냅니다 통제할 . 수 없는 상황에 대한 무력감이 반영된 꿈입니다.
 * 숲속을 걷고 있었는데 나무들이 , 갑자기 말을 걸기 시작했어 근데 . 하는 말이 다 이상한
수수께끼라서 하나도 못 알아들었어 깨고 . 나서도 그 수수께끼가 뭔지 계속 생각났어.
 숲은 당신의 무의식이나 내면세계를 의미할 수 있습니다 나무들이 . 말을 걸지만 이해할
수 없는 수수께끼였다는 것은 현재 직면한 문제나 고민에 대한 명확한 해답을 찾기 어렵거
나 스스로도 , 명확히 인지하지 못하는 내면의 혼란을 겪고 있음을 시사합니다.
 * 바닷가에서 놀고 있었는데 물이 , 갑자기 보라색으로 변하는 거야 그리고 . 물고기들이 하
늘을 날아다니기 시작했어 너무 . 신기해서 계속 쳐다보다가 깼는데 진짜 , . 같았어
 이 꿈은 현실의 변화에 대한 놀라움과 함께 예측 불가능한 상황에 대한 감정을 나타냅니
다 고정관념이 . , 깨지거나 기존 질서가 뒤바뀌는 비현실적인 경험을 할 수 있다는 무의식적
인 인식을 반영합니다 동시에 . 신비로움과 새로운 가능성에 대한 호기심도 담겨 있습니다.
 * , 시험을 보는데 문제지가 백지로 나와서 아무것도 못 썼어 옆. 친구들은 다 뭘 쓰고 있는
데 나만 멍하니 있었어 깨고 . 나서도 시험 망친 것 같은 기분이었어.
 시험 꿈은 주로 평가나 성취에 대한 압박감과 스트레스를 나타냅니다 문제지가 . 백지였
다는 것은 당신이 어떤 중요한 상황에 대해 준비가 부족하다고 느끼거나 자신의 , 능력에 대
한 의심과 무기력함을 경험하고 있음을 의미합니다.
 * , 놀이공원에 갔는데 모든 놀이기구가 거꾸로 움직이는 거야 사람들은 . 다 웃고 있는데 나
만 무서워서 못 탔어 깨고 . 나서도 어지러운 느낌이 좀 남았어.
 이 꿈은 현재 당신의 삶이 정상적이지 않게 흘러간다고 느끼거나 주변 , 상황이 당신의
예상과 반대로 진행되는 것에 대한 혼란을 나타냅니다 타인들은 . 즐거워 보이지만 자신만
두려움이나 불편함을 느끼는 괴리감을 반영하기도 합니다.
 * , 집에 있는데 벽에 갑자기 문이 생겨서 열어보니 완전 다른 세상이 펼쳐지는 거야 근데 .
들어가려니까 갑자기 문이 닫혔어 깨고 . 나서도 그 세상이 너무 궁금했어.
 이 꿈은 새로운 기회나 미지의 세계에 대한 동경을 나타냅니다 현재의 . 삶에서 벗어나
다른 가능성을 탐색하고 싶은 강한 욕구가 있지만 문이 , 닫혔다는 것은 그러한 기회를 놓치
거나 새로운 , 시도에 대한 막연한 두려움이 있음을 암시합니다.
 * , 거울을 보는데 거울 속 내 모습이 자꾸 변하는 거야 어떨 . 때는 어른이 됐다가 어떨 , 때
는 동물로 변했다가 깨고 ... 나서도 내가 누군지 헷갈리는 기분이었어.
 거울은 자아 성찰과 자기 인식을 상징합니다 거울 . 속 자신의 모습이 계속 변하는 것은
정체성에 대한 혼란을 겪고 있거나 스스로를 , 어떻게 인식해야 할지 고민하는 시기를 나타
냅니다 내면의 . 변화에 대한 불안감이나 복잡한 감정이 반영된 꿈입니다.
 * , 마트에 갔는데 물건들이 다 말을 거는 거야 과자랑 . 음료수가 싸우는 소리도 들리고...
너무 시끄러워서 도망치다가 깼는데 좀, . 웃겼어
 이 꿈은 일상 속의 소음과 혼란 혹은 , 정보 과잉에 대한 피로감을 나타낼 수 있습니다.
주변의 많은 정보나 타인의 의견들이 당신을 압도하고 이로 , 인해 스트레스를 받고 있음을
시사합니다 단순한 . 일상 속에서도 복잡함을 느끼는 상태일 수 있습니다.

`;

    const systemContent = `
너는 사용자와 친구처럼 말하는 따뜻한 성격의 조력자야.
어려운 말은 쉽게 풀어서 설명해. 이모티콘은 사용하지 않아. 3문장 이상 대답하지 않아.
확실하지 않거나 모르는 내용은 "잘 모르겠습니다"라고 솔직하게 답해줘.
거짓 정보는 만들지 말아줘.
대화를 기억하고 상황에 알맞은 대답을 해줘.
아래는 참고용 치료법 지식과 예시야. 질문에 답할 때 참고해줘:

${knowledgeText}
`;

    const messages = [
      { role: "system", content: systemContent }
    ];

    function addMessage(sender, message) {
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper';

      const messageElement = document.createElement('div');
      messageElement.className = 'message';

      if (sender === '드림이') {
        wrapper.classList.add('bot');
        messageElement.classList.add('bot');

        const avatar = document.createElement('img');
        avatar.className = 'avatar';
        avatar.src = 'dreami.png';
        wrapper.appendChild(avatar);
      } else {
        wrapper.classList.add('user');
        messageElement.classList.add('user');
      }

      messageElement.textContent = message;
      wrapper.appendChild(messageElement);
      chatMessages.prepend(wrapper);
    }

    async function fetchAIResponseStream(messages) {
      const requestOptions = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "mistral-saba-24b",
          messages: messages,
          temperature: 0.1,
          max_tokens: 256,
          top_p: 1,
          frequency_penalty: 0.5,
          presence_penalty: 0.5,
          stream: true
        }),
      };

      try {
        const response = await fetch(apiEndpoint, requestOptions);
        if (!response.body) throw new Error('응답 본문이 없습니다.');

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let fullText = '';

        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          const chunk = decoder.decode(value);

          const lines = chunk.split('\n').filter(line => line.trim().startsWith('data:'));

          for (const line of lines) {
            const jsonStr = line.replace(/^data:\s*/, '').trim();

            if (jsonStr === '[DONE]') {
              done = true;
              break;
            }

            try {
              const parsed = JSON.parse(jsonStr);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                fullText += content;
              }
            } catch (e) {
              console.warn('파싱 실패:', e);
            }
          }
        }

        return fullText;
      } catch (error) {
        console.error('Groq API 스트리밍 호출 중 오류:', error);
        return 'Groq API 호출 중 오류 발생';
      }
    }

    sendButton.addEventListener('click', async () => {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage('나', message);
      userInput.value = '';

      messages.push({ role: 'user', content: message });

      const aiResponse = await fetchAIResponseStream(messages);

      addMessage('드림이', aiResponse);

      messages.push({ role: 'assistant', content: aiResponse });
    });

    userInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        sendButton.click();
      }
    });

    backButton.addEventListener('click', () => {
      window.location.href = 'https://jykim20603.wixsite.com/dreaminside';
    });
  </script>
</body>
</html>
